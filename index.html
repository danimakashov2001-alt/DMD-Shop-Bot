<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</title>

<link rel="stylesheet" href="https://unpkg.com/photoswipe@5/dist/photoswipe.css">

<style>
  html, body {
    margin:0; padding:0; width:100%; height:100%;
    font-family:-apple-system,BlinkMacSystemFont,Arial;
    color:#fff;
    background: url("https://iili.io/fXfx3ep.jpg") center / cover no-repeat;
    background-color:#0b0b0b;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.55);
    pointer-events:none;
    z-index:-1;
  }

  header{
    height:46px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 14px;
    background:rgba(17,17,17,0.9);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    font-weight:600;
    gap:12px;
  }
  .header-title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .header-actions{
    display:flex;
    align-items:center;
    gap:10px;
    flex-shrink:0;
  }

  .btn{
    appearance:none;
    border:1px solid rgba(255,255,255,0.12);
    padding:8px 12px;
    border-radius:12px;
    background:rgba(31,31,31,0.75);
    color:#fff;
    font-weight:600;
    cursor:pointer;
  }
  .btn:active{ transform:scale(0.98); }

  .page{ height:calc(100vh - 46px); overflow-y:auto; }

  /* ===== –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –ª–µ–Ω—Ç—ã (–∫–∞–∫ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ), –Ω–æ –≤ —Ç–≤–æ–µ–π –≥–∞–º–º–µ ===== */
  .catalog{
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .card{
    border-radius:16px;
    overflow:hidden;
    cursor:pointer;
    position:relative;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.10);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    padding:12px;
  }

  .card-top{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom:10px;
  }

  .name{
    font-weight:900;
    font-size:18px;
    line-height:1.1;
    margin:0;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }

  .price{
    font-weight:900;
    font-size:18px;
    white-space:nowrap;
    opacity:0.98;
    margin-left:auto;
  }

  /* ===== –ö–æ–ª–ª–∞–∂: 3 —Ñ–æ—Ç–æ (–±–µ–∑ –¥—É–±–ª–µ–π) ===== */
  .collage{
    display:grid;
    gap:8px;
    margin-bottom:10px;
  }
  .collage.three{
    grid-template-columns:repeat(3, 1fr);
    grid-auto-rows:78px;
  }
  .collage.three .big{
    grid-column:1 / span 2;
    grid-row:1 / span 2;
    height: calc(78px * 2 + 8px);
  }
  .collage.two{
    grid-template-columns:repeat(2, 1fr);
    grid-auto-rows:160px;
  }
  .collage.one{
    grid-template-columns:1fr;
    grid-auto-rows:220px;
  }

  .collage .img{
    width:100%;
    height:100%;
    border-radius:14px;
    object-fit:cover;
    display:block;
    background:rgba(255,255,255,0.08);
    user-select:none;
    -webkit-user-drag:none;

    /* ‚úÖ –£–±–∏—Ä–∞–µ–º —Å–∏–Ω–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ/–ø–æ–¥—Å–≤–µ—Ç–∫—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    -webkit-touch-callout: none;
    outline: none;
  }

  /* ‚úÖ –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∏–¥—ë—Ç –æ—Ç —Ñ–æ–∫—É—Å–∞/–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ */
  .collage .img:focus,
  .collage .img:active{
    outline:none;
  }

  @media (max-width:420px){
    .collage.three{ grid-auto-rows:82px; }
    .collage.three .big{ height: calc(82px * 2 + 8px); }
    .collage.two{ grid-auto-rows:170px; }
    .collage.one{ grid-auto-rows:240px; }
  }

  /* description –≤ –ª–µ–Ω—Ç–µ */
  .short-desc{
    margin:0 0 10px;
    color:rgba(255,255,255,0.88);
    font-size:13px;
    line-height:1.25;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }

  .metaRow{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
  }

  .statusPill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    border-radius:999px;
    padding:7px 10px;
    font-weight:900;
    font-size:13px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(31,31,31,0.60);
    color:#fff;
  }
  .dot{
    width:10px; height:10px; border-radius:50%;
    display:inline-block;
  }
  .instock .dot{ background:#38d66b; }
  .inway .dot{ background:#ffd54a; }

  .is-hidden{ display:none !important; }
  .empty{ padding:14px; color:rgba(255,255,255,0.85); font-size:13px; }

  /* –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ */
  .categories{ padding:14px; display:flex; flex-direction:column; gap:12px; }
  .cat-card{
    background:rgba(17,17,17,0.85);
    border:1px solid rgba(255,255,255,0.10);
    border-radius:16px;
    padding:12px 12px 10px;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  .cat-title{ font-weight:900; margin-bottom:10px; }
  .subcats{ display:flex; flex-wrap:wrap; gap:10px; }
  .chip{
    padding:8px 12px;
    border-radius:999px;
    background:rgba(31,31,31,0.75);
    border:1px solid rgba(255,255,255,0.10);
    cursor:pointer;
    user-select:none;
    font-size:13px;
  }
  .chip:active{ transform:scale(0.98); }
  .hint{ padding:0 14px 14px; color:rgba(255,255,255,0.78); font-size:12px; }

  /* Toast (–∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π, –Ω–µ ‚Äú–æ–±—ä—ë–º–Ω—ã–π‚Äù) */
  .toast{
    position:fixed;
    left:50%;
    bottom:18px;
    transform:translateX(-50%);
    padding:8px 12px;
    border-radius:12px;
    background:rgba(0,0,0,0.55);
    border:1px solid rgba(255,255,255,0.10);
    color:rgba(255,255,255,0.92);
    font-size:13px;
    line-height:1;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease, transform .18s ease;
    z-index:999999;
    white-space:nowrap;
  }
  .toast.show{
    opacity:1;
    transform:translateX(-50%) translateY(-2px);
  }

  /* =========================================================
     Caption –≤–Ω—É—Ç—Ä–∏ PhotoSwipe
     ========================================================= */
  .pswp__guru-caption{
    position:absolute;
    left:0; right:0; bottom:0;
    z-index: 100000;
    box-sizing:border-box;

    padding:14px 16px;
    padding-bottom: calc(14px + env(safe-area-inset-bottom));

    background:linear-gradient(transparent, rgba(0,0,0,0.92));
    color:#fff;
    font-size:13px;
    line-height:1.35;

    pointer-events:none;
    text-shadow: 0 1px 2px rgba(0,0,0,0.65);
    transition:opacity .16s ease;
    opacity:1;
  }
  .pswp__guru-caption.is-hidden-by-zoom{ opacity:0; }

  .pswp__guru-caption .title{
    font-size:15px;
    font-weight:900;
    margin-bottom:6px;
  }
  .pswp__guru-caption .desc{
    white-space:pre-line;
    opacity:0.96;
  }
  .pswp__guru-caption .meta{
    margin-top:8px;
    font-weight:900;
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .pswp__guru-caption .instock{ color:#38d66b; }
  .pswp__guru-caption .inway{ color:#ffd54a; }
</style>
</head>

<body>
<header>
  <div class="header-title" id="headerTitle">üõç –ö–∞—Ç–∞–ª–æ–≥</div>

  <div class="header-actions">
    <button class="btn" id="homeBtn">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    <button class="btn" id="toggleBtn">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
  </div>
</header>

<div class="page" id="productsPage">
  <div class="catalog" id="catalog"></div>
  <div class="empty is-hidden" id="emptyState">–ü–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ —ç—Ç–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</div>
</div>

<div class="page is-hidden" id="categoriesPage">
  <div class="categories" id="categories"></div>
  <div class="hint">–ù–∞–∂–º–∏ –Ω–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Äî –ø–æ–∫–∞–∂—É —Ç–æ–≤–∞—Ä—ã.</div>
</div>

<div class="toast" id="toast">–í—ã —É–∂–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ</div>

<script type="module">
import PhotoSwipeLightbox from 'https://unpkg.com/photoswipe@5/dist/photoswipe-lightbox.esm.min.js';

/* ====== –¢–æ–≤–∞—Ä—ã ====== */
const products = [
  {
    name:"–ó–∏–ø —Ö—É–¥–∏ Zara Type crop fit (—Å–µ—Ä—ã–π)",
    price:4300,
    status:"–í –Ω–∞–ª–∏—á–∏–∏",
    description:"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏: 185/70, —Ä–∞–∑–º–µ—Ä L.",
    fullDescription:
`–ó–∏–ø —Ö—É–¥–∏ Zara Type crop fit (—Å–µ—Ä—ã–π)

‚Ä¢ ‚úîÔ∏è –üap–∞–ºe—Çp—ã –ºo–¥–µ–ª–∏ –Ω–∞ —Ñ–æ—Ç–æ: 185/70, p–∞–∑–ºe—Ä –•L (–Ω–æc–∏—Ç –æversiz–µ)
‚Ä¢ ‚úîÔ∏è –ü–ªo—Ç–Ω–æc—Ç—å 520 –≥/–º¬≤ ‚Äî –≥–ªa–≤–Ω—ã–π –∫o–∑—ãp—å –ºo–¥–µ–ª–∏. –¢–∞–∫–æ–π –≤–µ—Å –≥ap–∞–Ω—Ç–∏p—É–µ—Ç, —á—Ç–æ —Ö—É–¥–∏ –øp–µ–∫—Ä–∞—Å–Ω–æ –¥e—Ä–∂–∏—Ç —Ñ–æp–º—É, –Ω–µ —Ç—è–Ω–µ—Çc—è –∏ –Ω–µ –¥–µ—Ñop–º–∏p—Ée—Ç—Å—è –ø–æc–ªe c—Ç–∏—Äo–∫
‚Ä¢ ‚úîÔ∏è –¢–µ–ø–ª—ã–π —Ñ–ª–∏c–æ–≤—ã–π –ø–æ–¥–∫–ªa–¥ ‚Äî –≤–Ω—É—Çp–∏ –∫–æ—Ñ—Ç—ã –º—è–≥–∫–∏–π, brushed-–øo–¥–∫–ª–∞–¥, —Å–æ–∑–¥a—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç —Ç–µp–º–æ–±e–ª—å—è
‚Ä¢ ‚úîÔ∏è –ò–¥ea–ª—å–Ω—ã–π c–æc—Ça–≤ 80% x–ªo–øo–∫ / 20% –ø–æ–ª–∏—ç—Å—Ç–µ—Ä ‚Äî –∑–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞! –•–ª–æ–ø–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ–º—Ñ–æ—Ä—Ç, –ø–æ–ª–∏—ç—Å—Ç–µ—Ä ‚Äî –ø—Ä–æ—á–Ω–æ—Å—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞`,
    subcategory:"zip_hoodies",
    photos:[
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448733/%D0%A1%D0%B5%D1%80%D0%B0%D1%8F_1_uurzdj.jpg",
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448732/%D0%A1%D0%B5%D1%80%D0%B0%D1%8F_2_xyc09s.jpg",
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448731/%D0%A1%D0%B5%D1%80%D0%B0%D1%8F_4_kkcqly.jpg",
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448730/%D0%A1%D0%B5%D1%80%D0%B0%D1%8F_3_dounz3.jpg"
    ]
  },
  {
    name:"–ó–∏–ø —Ö—É–¥–∏ Zara Type crop fit (—á—ë—Ä–Ω—ã–π)",
    price:4300,
    status:"–í –Ω–∞–ª–∏—á–∏–∏",
    description:"–ú–∏–Ω–∏–º–∞–ª–∏–∑–º. –ü–ª–æ—Ç–Ω—ã–π —Ö–ª–æ–ø–æ–∫.",
    fullDescription:
`–ó–∏–ø —Ö—É–¥–∏ Zara Type crop fit (—á—ë—Ä–Ω—ã–π)

‚Ä¢ –üapa–º–µ—Ç—Ä—ã –º–æ–¥e–ª–∏: 185/70 p–∞–∑–º–µ—Ä –Ω–∞ —Ño—Ç–æ XL
‚Ä¢ ‚úîÔ∏è–ü–ª–æ—Ç–Ω–æ—Å—Ç—å 520 –≥/–º¬≤ ‚Äî —ç—Ç–æ –≥–ª–∞–≤–Ω—ã–π –∫–æ–∑—ã—Ä—å –º–æ–¥–µ–ª–∏. –¢–∞–∫–æ–π –≤–µ—Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ö—É–¥–∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –¥–µ—Ä–∂–∏—Ç —Ñ–æ—Ä–º—É, –Ω–µ —Ç—è–Ω–µ—Ç—Å—è –∏ –Ω–µ –¥–µ—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å—Ç–∏—Ä–æ–∫
‚Ä¢ ‚úîÔ∏è–¢–µ–ø–ª—ã–π —Ñ–ª–∏—Å–æ–≤—ã–π –ø–æ–¥–∫–ª–∞–¥ ‚Äî –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ñ—Ç—ã –º—è–≥–∫–∏–π, brush–µd-–ø–æ–¥–∫–ª–∞–¥, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç —Ç–µ—Ä–º–æ–±–µ–ª—å—è
‚Ä¢ ‚úîÔ∏è –ò–¥–µ–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤ 80% —Ö–ª–æ–ø–æ–∫ / 20% –ø–æ–ª–∏—ç—Å—Ç–µ—Ä ‚Äî –∑–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞! –•–ª–æ–ø–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ—Å—Ç—å, –≥–∏–≥—Ä–æ—Å–∫–æ–ø–∏—á–Ω–æ—Å—Ç—å –∏ –∫–æ–º—Ñ–æ—Ä—Ç –ø—Ä–∏ –Ω–æ—Å–∫–µ. –ü–æ–ª–∏—ç—Å—Ç–µ—Ä –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–∫–∞–Ω–∏ –ø—Ä–æ—á–Ω–æ—Å—Ç–∏, –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–∏–ª—å–Ω—É—é —É—Å–∞–¥–∫—É`,
    subcategory:"zip_hoodies",
    photos:[
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448735/%D0%A7%D1%91%D1%80%D0%BD%D0%B0%D1%8F_1_zq9soo.jpg",
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448734/%D0%A7%D1%91%D1%80%D0%BD%D0%B0%D1%8F_3_wkoqkr.jpg",
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448733/%D0%A7%D1%91%D1%80%D0%BD%D0%B0%D1%8F_2_qphj1p.jpg",
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448734/%D0%A7%D1%—ë%D1%80%D0%BD%D0%B0%D1%8F_4_jqxxme.jpg"
    ]
  },
  {
    name:"–õ–æ–Ω–≥—Å–ª–∏–≤ Derschutze crop fit",
    price:3890,
    status:"–í –Ω–∞–ª–∏—á–∏–∏",
    description:"–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –≤—ã—à–∏–≤–∫–∞.",
    fullDescription:
`–õ–æ–Ω–≥—Å–ª–∏–≤ Derschutze crop fit

‚Ä¢ ‚úîÔ∏è –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π p–∞–∑–º–µ—Ä ‚Äî –ú. –°–≤–æ–±o–¥–Ω—ã–π –∫—Äo–π —Å —É–∫–æpo—áe–Ω–Ω—ã–º c–∏–ª—É—ç—Ç–æ–º (–∫p–æ–ø)
‚Ä¢ ‚úîÔ∏è B—ãco–∫o–∫a—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –≤—ã—à–∏–≤–∫–∞ –Ω–∞ c–ø–∏–Ωe
‚Ä¢ ‚úîÔ∏è 97% —Ö–ªo–ø–æ–∫, 3% —ç–ª–∞c—Ç–∞–Ω
‚Ä¢ ‚úîÔ∏è –öa—á–µ—Å—Ç–≤e–Ω–Ω—ã–π –øo—à–∏–≤. Bc–µ –¥–µ—Ça–ª–∏ (–±–∏p–∫a, —Å—Çp–æ—á–∫–∞, –≤—ã—à–∏–≤–∫a) ‚Äî –≤–∏–¥–Ω—ã –Ω–∞ —Ñ–æ—Ço
‚Ä¢ ‚úîÔ∏è –≠–∫c–∫–ª—é–∑–∏–≤: –≠—Ç–æ e–¥–∏–Ωc—Ç–≤–µ–Ω–Ω—ã–π –ª–æ–Ω–≥—Å–ª–∏–≤ –¥–∞–Ω–Ωo–π –ºo–¥–µ–ª–∏ –æ—Ç —ç—Ç–æ–≥o –±pe–Ω–¥–∞, –øpe–¥c—Ça–≤–ª–µ–Ω–Ω—ã–π –≤ –†–§`,
    subcategory:"longsleeves",
    photos:[
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448729/%D0%9B%D0%BE%D0%BD%D0%B3_1_nas66k.jpg",
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448730/%D0%9B%D0%BE%D0%BD%D0%B3_2_gltmgg.jpg",
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448729/%D0%9B%D0%BE%D0%BD%D0%B3_3_qhm47n.jpg",
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448729/%D0%9B%D0%BE%D0%BD%D0%B3_4_epjpgv.jpg",
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448728/%D0%9B%D0%BE%D0%BD%D0%B3_5_q92inj.jpg",
      "https://res.cloudinary.com/dlscsqfox/image/upload/v1767448729/%D0%9B%D0%BE%D0%BD%D0%B3_6_gtwfxx.jpg"
    ]
  }
];

/* ====== –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ====== */
const categoryTree = [
  { title: "–ì–æ–ª–æ–≤–Ω—ã–µ —É–±–æ—Ä—ã", subs: ["–®–∞–ø–∫–∏", "–ö–µ–ø–∫–∏"] },
  { title: "–í–µ—Ä—Ö", subs: ["–ó–∏–ø –•—É–¥–∏", "–õ–æ–Ω–≥—Å–ª–∏–≤—ã", "–§—É—Ç–±–æ–ª–∫–∏"] },
  { title: "–ù–∏–∑", subs: ["–î–∂–∏–Ω—Å—ã", "–ë—Ä—é–∫–∏", "–®–æ—Ä—Ç—ã"] },
  { title: "–û–±—É–≤—å", subs: ["–ö—Ä–æ—Å—Å–æ–≤–∫–∏", "–¢—É—Ñ–ª–∏"] }
];

const subcategoryMap = {
  "–ó–∏–ø –•—É–¥–∏": "zip_hoodies",
  "–õ–æ–Ω–≥—Å–ª–∏–≤—ã": "longsleeves",
};

function statusClass(status){
  const s = (status || "").toLowerCase();
  if (s.includes("–≤ –Ω–∞–ª–∏—á–∏–∏")) return "instock";
  if (s.includes("–≤ –ø—É—Ç–∏")) return "inway";
  return "";
}

function formatPrice(value){
  const n = Number(value ?? 0);
  if (!Number.isFinite(n)) return String(value ?? "");
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

/* ====== DOM ====== */
const headerTitle = document.getElementById("headerTitle");
const homeBtn = document.getElementById("homeBtn");
const toggleBtn = document.getElementById("toggleBtn");
const productsPage = document.getElementById("productsPage");
const categoriesPage = document.getElementById("categoriesPage");
const catalog = document.getElementById("catalog");
const categoriesEl = document.getElementById("categories");
const emptyState = document.getElementById("emptyState");
const toastEl = document.getElementById("toast");

let currentFilter = null;     // null = –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
let currentProduct = null;

/* ===== Toast ===== */
let toastTimer = null;
function showToast(text){
  toastEl.textContent = text;
  toastEl.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toastEl.classList.remove("show"), 2000);
}

/* ===== –≠–∫—Ä–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
function isOnHome() {
  const catsHidden = categoriesPage.classList.contains("is-hidden");
  return catsHidden && currentFilter === null;
}

/* ====== –†–µ–Ω–¥–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤ ====== */
function renderProducts() {
  catalog.innerHTML = "";
  emptyState.classList.add("is-hidden");

  const list = currentFilter
    ? products.filter(p => p.subcategory === currentFilter)
    : products;

  if (list.length === 0) {
    emptyState.classList.remove("is-hidden");
    return;
  }

  list.forEach((product) => {
    const stCls = statusClass(product.status);
    const photos = Array.isArray(product.photos) ? product.photos : [];
    const count = photos.length;

    const card = document.createElement("div");
    card.className = "card";
    card.__product = product;

    // Top: name + price
    const top = document.createElement("div");
    top.className = "card-top";
    top.innerHTML = `
      <h3 class="name">${product.name}</h3>
      <div class="price">${formatPrice(product.price)} ‚ÇΩ</div>
    `;
    card.appendChild(top);

    // Collage without duplicates
    const collage = document.createElement("div");

    if (count >= 3) {
      collage.className = "collage three";
      // big + 2 small (–ø–µ—Ä–≤—ã–µ 3 —Ñ–æ—Ç–æ)
      const big = document.createElement("img");
      big.className = "img big";
      big.src = photos[0];
      big.alt = product.name;
      big.dataset.open = "1";
      collage.appendChild(big);

      const s1 = document.createElement("img");
      s1.className = "img";
      s1.src = photos[1];
      s1.alt = product.name;
      s1.dataset.open = "1";
      collage.appendChild(s1);

      const s2 = document.createElement("img");
      s2.className = "img";
      s2.src = photos[2];
      s2.alt = product.name;
      s2.dataset.open = "1";
      collage.appendChild(s2);
    } else if (count === 2) {
      collage.className = "collage two";
      const i1 = document.createElement("img");
      i1.className = "img";
      i1.src = photos[0];
      i1.alt = product.name;
      i1.dataset.open = "1";
      collage.appendChild(i1);

      const i2 = document.createElement("img");
      i2.className = "img";
      i2.src = photos[1];
      i2.alt = product.name;
      i2.dataset.open = "1";
      collage.appendChild(i2);
    } else if (count === 1) {
      collage.className = "collage one";
      const i1 = document.createElement("img");
      i1.className = "img";
      i1.src = photos[0];
      i1.alt = product.name;
      i1.dataset.open = "1";
      collage.appendChild(i1);
    }

    if (count > 0) card.appendChild(collage);

    // description
    const desc = document.createElement("div");
    desc.className = "short-desc";
    desc.textContent = product.description ?? "";
    card.appendChild(desc);

    // Status only
    const meta = document.createElement("div");
    meta.className = "metaRow";
    meta.innerHTML = `
      <div class="statusPill ${stCls}">
        <span class="dot"></span>
        <span>${product.status ?? ""}</span>
      </div>
      <div></div>
    `;
    card.appendChild(meta);

    catalog.appendChild(card);
  });
}

/* ====== –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π ====== */
function renderCategories() {
  categoriesEl.innerHTML = "";
  categoryTree.forEach(cat => {
    const wrap = document.createElement("div");
    wrap.className = "cat-card";
    wrap.innerHTML = `<div class="cat-title">${cat.title}</div>`;

    const subs = document.createElement("div");
    subs.className = "subcats";

    cat.subs.forEach(subName => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = subName;
      chip.dataset.subname = subName;
      subs.appendChild(chip);
    });

    wrap.appendChild(subs);
    categoriesEl.appendChild(wrap);
  });
}

/* ====== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ ====== */
function openCategories() {
  productsPage.classList.add("is-hidden");
  categoriesPage.classList.remove("is-hidden");
  toggleBtn.textContent = "–ù–∞–∑–∞–¥";
  headerTitle.textContent = "üìö –ö–∞—Ç–µ–≥–æ—Ä–∏–∏";
}

function closeCategories() {
  categoriesPage.classList.add("is-hidden");
  productsPage.classList.remove("is-hidden");
  toggleBtn.textContent = "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏";
  headerTitle.textContent = currentFilter ? "üõç –ö–∞—Ç–∞–ª–æ–≥ ‚Ä¢ —Ñ–∏–ª—å—Ç—Ä" : "üõç –ö–∞—Ç–∞–ª–æ–≥";
}

toggleBtn.addEventListener("click", () => {
  const isOpen = !categoriesPage.classList.contains("is-hidden");
  isOpen ? closeCategories() : openCategories();
});

categoriesEl.addEventListener("click", (e) => {
  const chip = e.target.closest(".chip");
  if (!chip) return;

  const mapped = subcategoryMap[chip.dataset.subname];
  currentFilter = mapped || "__none__";
  renderProducts();
  closeCategories();
});

/* ====== –ö–Ω–æ–ø–∫–∞ "–ù–∞ –≥–ª–∞–≤–Ω—É—é" ====== */
homeBtn.addEventListener("click", () => {
  if (isOnHome()) {
    showToast("–í—ã —É–∂–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ");
    return;
  }

  // –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é: –∑–∞–∫—Ä—ã—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —É–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
  currentFilter = null;
  renderProducts();
  closeCategories();
});

/* ====== Caption –≤–Ω—É—Ç—Ä–∏ PhotoSwipe ====== */
function ensureGuruCaption(pswp) {
  const root = pswp.element;
  if (!root) return null;

  let cap = root.querySelector('#guruCaption');
  if (!cap) {
    cap = document.createElement('div');
    cap.id = 'guruCaption';
    cap.className = 'pswp__guru-caption';
    cap.innerHTML = `
      <div class="title" id="guruTitle"></div>
      <div class="desc" id="guruDesc"></div>
      <div class="meta" id="guruMeta"></div>
    `;
    root.appendChild(cap);
  }
  return cap;
}

function fillGuruCaption(product) {
  const t = document.getElementById('guruTitle');
  const d = document.getElementById('guruDesc');
  const m = document.getElementById('guruMeta');
  if (!t || !d || !m) return;

  t.textContent = product?.name ?? '';

  const text = (product?.fullDescription && String(product.fullDescription).trim())
    ? product.fullDescription
    : (product?.description ?? '');
  d.textContent = text;

  const stCls = statusClass(product?.status);
  const statusHtml = product?.status ? `<span class="${stCls}">${product.status}</span>` : '';
  const priceHtml = product?.price != null ? `<span>${formatPrice(product.price)} ‚ÇΩ</span>` : '';
  m.innerHTML = `${statusHtml}${priceHtml ? " ‚Ä¢ " + priceHtml : ""}`;
}

/* ‚úÖ –°–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –õ–Æ–ë–û–ú –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–∞—Å—à—Ç–∞–±–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±–∞–∑–æ–≤–æ–≥–æ */
function syncGuruCaptionVisibility(pswp) {
  const cap = document.getElementById('guruCaption');
  if (!cap) return;

  const slide = pswp.currSlide;
  if (!slide || !slide.zoomLevels) return;

  const base = slide.zoomLevels.initial;
  const curr = slide.currZoomLevel || base;

  const eps = 0.01;
  const isBase = Math.abs(curr - base) < eps;

  cap.classList.toggle('is-hidden-by-zoom', !isBase);
}

/* ====== PhotoSwipe ====== */
const lightbox = new PhotoSwipeLightbox({
  pswpModule: () => import('https://unpkg.com/photoswipe@5/dist/photoswipe.esm.min.js'),
  wheelToZoom: true,
  arrowKeys: true,
  pswpOptions: {
    closeOnScroll: false,
    initialZoomLevel: 'fill',
    secondaryZoomLevel: 2,
    maxZoomLevel: 4,
    bgOpacity: 1,
    padding: { top: 0, bottom: 0, left: 0, right: 0 }
  }
});

lightbox.on('afterInit', () => {
  const pswp = lightbox.pswp;

  ensureGuruCaption(pswp);
  fillGuruCaption(currentProduct);
  syncGuruCaptionVisibility(pswp);

  pswp.on('zoomPanUpdate', () => syncGuruCaptionVisibility(pswp));
  pswp.on('change', () => syncGuruCaptionVisibility(pswp));

  pswp.on('doubleTap', () => {
    const slide = pswp.currSlide;
    if (!slide || !slide.zoomLevels) return;

    const base = slide.zoomLevels.initial;
    const curr = slide.currZoomLevel || base;
    const target = (Math.abs(curr - base) < 0.01) ? 2 : base;

    pswp.zoomTo(target, { x: pswp.viewportSize.x/2, y: pswp.viewportSize.y/2 });
  });

  pswp.on('destroy', () => {
    const cap = document.getElementById('guruCaption');
    if (cap) cap.remove();
  });
});

lightbox.init();

/* ====== –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫: –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ—Ç–æ ====== */
catalog.addEventListener("click", (e) => {
  const img = e.target.closest("img[data-open='1']");
  if (!img) return;

  const card = e.target.closest(".card");
  if (!card) return;

  const product = card.__product;
  if (!product) return;

  currentProduct = product;

  const items = (product.photos || []).map((src) => ({
    src,
    width: 1600,
    height: 2000
  }));

  lightbox.loadAndOpen(0, items);
});

/* init */
renderProducts();
renderCategories();
</script>

</body>
</html>

